parameters:
    # the time in seconds determines how often a database ping service being called
    oro_sync.db_ping.interval: 20
    # the time in seconds determines how often a websocket ping service being called
    oro_sync.websocket_ping.interval: 50

services:
    oro_sync.manager.topic_manager:
        class: Oro\Bundle\SyncBundle\Manager\TopicManager
        parent: gos_web_socket.wamp.topic_manager
        decorates: gos_web_socket.wamp.topic_manager

    oro_sync.periodic.db_ping:
        class: Oro\Bundle\SyncBundle\Periodic\DbPingPeriodic
        arguments:
            - '@doctrine'
            - '%oro_sync.db_ping.interval%'
        calls:
            - [ setLogger, [ '@logger' ] ]
        tags:
            - { name: gos_web_socket.periodic }
            - { name: monolog.logger, channel: oro_websocket }

    oro_sync.topic.websocket_ping:
        class: Oro\Bundle\SyncBundle\Topic\WebsocketPingTopic
        arguments:
            - 'oro_sync.ping'
            - '%oro_sync.websocket_ping.interval%'
        calls:
            - [ setLogger, [ '@logger' ] ]
        tags:
            - { name: gos_web_socket.topic }
            - { name: monolog.logger, channel: oro_websocket }

    oro_sync.twig.sync_extension:
        class: Oro\Bundle\SyncBundle\Twig\OroSyncExtension
        arguments:
            - '@oro_platform.twig.service_locator'
        tags:
            - { name: twig.extension }

    oro_sync.client.connection_checker:
        class: Oro\Bundle\SyncBundle\Client\ConnectionChecker
        public: true
        arguments:
            - '@oro_sync.websocket_client.basic'
        calls:
            - [setLogger, ['@logger']]
            - [setApplicationState, ['@oro_distribution.handler.application_status']]
        tags:
            - { name: monolog.logger, channel: oro_websocket }

    oro_sync.event_listener.maintenance:
        class: Oro\Bundle\SyncBundle\EventListener\MaintenanceListener
        arguments:
            - '@oro_sync.websocket_client'
            - '@oro_sync.client.connection_checker'
            - '@oro_security.token_accessor'
        tags:
            - { name: kernel.event_listener, event: maintenance.on, method: onModeOn }
            - { name: kernel.event_listener, event: maintenance.off, method: onModeOff }

    oro_sync.topic.maintenance:
        class: Oro\Bundle\SyncBundle\Topic\BroadcastTopic
        arguments:
            - 'oro_sync.maintenance'
        tags:
            - { name: gos_web_socket.topic }

    oro_sync.authentication.origin_provider:
        class: Oro\Bundle\SyncBundle\Authentication\Origin\ChainOriginProvider
        arguments:
            - !tagged_iterator oro_sync.origin_provider

    oro_sync.authentication.application_origin_provider:
        class: Oro\Bundle\SyncBundle\Authentication\Origin\ApplicationOriginProvider
        arguments:
            - '@oro_config.global'
            - '@oro_sync.authentication.origin_extractor'
        tags:
            - { name: oro_sync.origin_provider }

    oro_sync.authentication.origin_registry.factory:
        class: Oro\Bundle\SyncBundle\Authentication\Origin\OriginRegistryFactory
        arguments:
            - '@oro_sync.authentication.origin_provider'

    oro_sync.loader.yaml:
        class:  Oro\Bundle\SyncBundle\Loader\YamlFileLoader
        parent: gos_pubsub_router.loader.yaml
        tags:
            - { name: gos_pubsub_router.routing.loader }

    oro_sync.authentication.origin_extractor:
        class: Oro\Bundle\SyncBundle\Authentication\Origin\OriginExtractor

    oro_sync.log.handler.websocket_server_console:
        class: Oro\Bundle\SyncBundle\Log\Handler\WebsocketServerConsoleHandler
        # Decorated handler service is specified along with the websocket monolog handler in Oro\Bundle\SyncBundle\DependencyInjection\OroSyncExtension
        # decorates: monolog.handler.websocket
        arguments:
            - '@.inner'

    oro_sync.websocket_server_state.shared_manager:
        class: Oro\Bundle\SyncBundle\WebsocketServerState\WebsocketServerSharedStateManager
        arguments:
            - '@doctrine'

    oro_sync.websocket_server_state.cache_manager:
        class: Oro\Bundle\SyncBundle\WebsocketServerState\WebsocketServerCacheStateManager
        arguments:
            - '@oro_sync.websocket_server_state.cache_manager.cache'

    oro_sync.websocket_server_state.cache_manager.cache:
        parent: oro.data.cache
        tags:
            - { name: cache.pool, namespace: oro_sync_websocket_server_state_cache_manager }

    oro_sync.websocket.server_stopper:
        class: Oro\Bundle\SyncBundle\WebSocket\WebsocketServerStopper
        arguments:
            - '@gos_web_socket.registry.periodic'
            - '@gos_web_socket.registry.server_push_handler'
        calls:
            - [ setLogger, [ '@logger' ] ]
        tags:
            - { name: monolog.logger, channel: oro_websocket }

    oro_sync.periodic.websocket_server_state.system_config:
        class: Oro\Bundle\SyncBundle\Periodic\WebsocketServerStateCheckPeriodic
        arguments:
            - '@oro_sync.websocket_server_state.shared_manager'
            - '@oro_sync.websocket.server_stopper'
            - !php/const Oro\Bundle\SyncBundle\WebsocketServerState\WebsocketServerStates::SYSTEM_CONFIG
        calls:
            - [ setLogger, [ '@logger' ] ]
        tags:
            - { name: gos_web_socket.periodic }
            - { name: kernel.event_listener, event: gos_web_socket.server_launched, method: onServerLaunched }
            - { name: monolog.logger, channel: oro_websocket }

    oro_sync.periodic.websocket_server_state.application_cache:
        class: Oro\Bundle\SyncBundle\Periodic\WebsocketServerStateCheckPeriodic
        arguments:
            - '@oro_sync.websocket_server_state.cache_manager'
            - '@oro_sync.websocket.server_stopper'
            - !php/const Oro\Bundle\SyncBundle\WebsocketServerState\WebsocketServerStates::APPLICATION_CACHE
        calls:
            - [ setLogger, [ '@logger' ] ]
        tags:
            - { name: gos_web_socket.periodic }
            - { name: kernel.event_listener, event: gos_web_socket.server_launched, method: onServerLaunched }
            - { name: monolog.logger, channel: oro_websocket }

    oro_sync.event_listener.system_config.websocket_server_state:
        class: Oro\Bundle\SyncBundle\EventListener\SystemConfig\WebsocketServerStateSystemConfigUpdateListener
        arguments:
            - '@oro_distribution.handler.application_status'
            - '@oro_sync.websocket_server_state.shared_manager'
        tags:
            - { name: kernel.event_listener, event: oro_config.update_after, method: onConfigUpdate }

    oro_sync.event_listener.load_termination_listeners_on_server_launch:
        class: Oro\Bundle\SyncBundle\EventListener\LoadTerminationListenersOnServerLaunchEventListener
        arguments:
            - '@event_dispatcher'
        tags:
            - { name: kernel.event_listener, event: gos_web_socket.server_launched, method: onServerLaunched }
